<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FEDDLib: /home/user/Programme/opt/FEDDLib/FEEDLIB_LEA/source/FEDDLib/feddlib/problems/abstract/TimeProblem_def.hpp Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">FEDDLib
   </div>
   <div id="projectbrief">Finite Element Domain Decomposition Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="../../dir_a7abe54e76939ade77b37861375e4c18.html">feddlib</a></li><li class="navelem"><a class="el" href="../../dir_77dd9975209729874a7e19874eee99bb.html">problems</a></li><li class="navelem"><a class="el" href="../../dir_ce66b1c668c4af9b799c5758e7e912c9.html">abstract</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">TimeProblem_def.hpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#ifndef TIMEPROBLEM_DEF_hpp</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="preprocessor">#define TIMEPROBLEM_DEF_hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor">#include &quot;TimeProblem_decl.hpp&quot;</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="keyword">using namespace </span>std;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="keyword">namespace </span><a class="code" href="../../d0/dac/namespaceFEDD.html">FEDD</a> {</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160; </div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;TimeProblem&lt;SC,LO,GO,NO&gt;::TimeProblem(Problem_Type&amp; problem, CommConstPtr_Type comm):</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;comm_(comm),</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;systemCombined_(),</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;systemMass_(),</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;timeParameters_(),</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;timeStepDef_(),</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;massParameters_(),</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;feFactory_(),</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;dimension_(problem.getDomain(0)-&gt;getDimension()),</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;verbose_(comm-&gt;getRank()==0),</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;parameterList_(problem.getParameterList()),</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;bcFactory_(problem.getBCFactory()),</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;massBCSet_(false),</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;solutionPreviousTimesteps_(0),</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;velocityPreviousTimesteps_(0),</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;accelerationPreviousTimesteps_(0),</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;systemMassPreviousTimeSteps_(0),</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;time_(0.)</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;#ifdef TIMEPROBLEM_TIMER</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;,TimeSolveTimer_ (Teuchos::TimeMonitor::getNewCounter(<span class="stringliteral">&quot;TT Problem: Solve&quot;</span>))</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;#endif</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;,precInitOnly_(false)</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;{</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    problem_ = Teuchos::rcpFromRef(problem);</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    BCConstPtr_Type bcFaCSI;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    <span class="keywordflow">if</span>( problem_-&gt;preconditioner_-&gt;hasFaCSIBCFactory() )</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;        bcFaCSI = problem_-&gt;preconditioner_-&gt;getFaCSIBCFactory();</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    </div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    problem_-&gt;preconditioner_ = Teuchos::rcp( <span class="keyword">new</span> Preconditioner_Type( <span class="keyword">this</span> ) ); <span class="comment">//we reset the preconditioner of underlying problem!</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    </div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keywordflow">if</span>( !bcFaCSI.is_null() )</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;        problem_-&gt;preconditioner_-&gt;setFaCSIBCFactory( bcFaCSI );</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    FEFacConstPtr_Type  facConst = problem.getFEFactory();</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    feFactory_ = Teuchos::rcp_const_cast&lt;FEFac_Type&gt;(facConst);</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    </div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    systemMass_.reset(<span class="keyword">new</span> BlockMatrix_Type(1));</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    systemCombined_.reset( <span class="keyword">new</span> BlockMatrix_Type( 1 ) );</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160; </div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;}</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160; </div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::setTimeDef( SmallMatrix&lt;int&gt;&amp; def ){</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    timeStepDef_ = def;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;}</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160; </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::assemble( std::string type )<span class="keyword"> const</span>{</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="comment">// If timestepping class is external, it is assumed that the full timedependent problem matrix and rhs are assembled during the assemble call(s)</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    std::string timestepping = parameterList_-&gt;sublist(<span class="stringliteral">&quot;Timestepping Parameter&quot;</span>).get(<span class="stringliteral">&quot;Class&quot;</span>,<span class="stringliteral">&quot;Singlestep&quot;</span>);</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <span class="keywordflow">if</span> (type == <span class="stringliteral">&quot;MassSystem&quot;</span>){</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        <span class="comment">// is not used in FSI</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;        <span class="comment">// systemMass_ wird gebaut (Massematrix), welche schon mit der Dichte \rho skaliert wurde</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        assembleMassSystem();</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160; </div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;        initializeCombinedSystems();</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;        <span class="keywordflow">if</span> (!nonLinProb.is_null()){<span class="comment">// we combine the nonlinear system with the mass matrix in the NonLinearSolver after the reassembly of each linear system</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        }</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;            <span class="keywordflow">if</span> (timestepping==<span class="stringliteral">&quot;External&quot;</span>)</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                this-&gt;systemCombined_ = problem_-&gt;getSystem();</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;                this-&gt;combineSystems();</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;        }</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    }</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        <span class="comment">//we need to tell the problem about the last solution if we use extrapolation!</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        problem_-&gt;assemble(type);</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        <span class="keywordflow">if</span> (timestepping==<span class="stringliteral">&quot;External&quot;</span>)</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;            this-&gt;systemCombined_ = problem_-&gt;getSystem();</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;            this-&gt;combineSystems();</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    }</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160; </div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    </div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    </div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="comment">//     // Fuer FSI</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment">//        if(this-&gt;parameterList_-&gt;sublist(&quot;Parameter&quot;).get(&quot;FSI&quot;,false))</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment">//        {</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment">//            bool geometryExplicit = this-&gt;parameterList_-&gt;sublist(&quot;Parameter&quot;).get(&quot;Geometry Explicit&quot;,true);</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment">//            NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment">//            TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, &quot;FSI problem is null.&quot;);</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">//            if (!type.compare(&quot;UpdateMeshDisplacement&quot;))</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment">//            {</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment">//                nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment">//                return;</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="comment">//            }</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="comment">//            else if (!type.compare(&quot;ForTime&quot;))</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment">//            {</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment">//                nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment">//                return;</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment">//            }</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment">//            else if (!type.compare(&quot;SolveGeometryProblem&quot;))</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment">//            {</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment">//                nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;<span class="comment">//                return;</span></div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="comment">//            }</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="comment">//            else if (!type.compare(&quot;UpdateTime&quot;))</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="comment">//            {</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="comment">//                nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="comment">//                return;</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="comment">//            }</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">//            else if (!type.compare(&quot;UpdateFluidInTime&quot;))</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment">//            {</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="comment">//                nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment">//                return;</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment">//            }</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">//            else if (!type.compare(&quot;MoveMesh&quot;))</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment">//            {</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="comment">//                nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">//                return;</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment">//            }</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment">//            else if (!type.compare(&quot;AddInterfaceBlockRHS&quot;))</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment">//            {</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment">//                nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">//                return;</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">//            }</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;<span class="comment">//            else if(!type.compare(&quot;ComputeFluidRHSInTime&quot;)){</span></div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="comment">//                nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;<span class="comment">//                return;</span></div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">//            }</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">//            else if(!type.compare(&quot;ComputeSolidRHSInTime&quot;)){</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="comment">//                nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<span class="comment">//                return;</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;<span class="comment">//            }</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;<span class="comment">//            else if(!geometryExplicit &amp;&amp; ( !type.compare(&quot;FixedPoint&quot;) || !type.compare(&quot;Newton&quot;) || !type.compare(&quot;NOX&quot;)) )</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="comment">//            {</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<span class="comment">//                // TODO: Brauchen wir irgendwann einmal, wenn wir Fluid:: oder</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;<span class="comment">//                // Struktur::reAssemble() aufrufen:</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment">//                // this-&gt;reAssemble(&quot;SetPartialSolutions&quot;);</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment">//                // rhs ist fix innerhalb eines Zeitschritts, da nur alter</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment">//                // Zeitschritt genutzt wird. Nur Massematrix neu assemblieren.</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment">//                // ACHTUNG: Bei SetFluidMassematrix wird auch immer</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment">//                // systemMass_ von timeProblemFluid_ ueberschrieben!</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment">//                // Da wir aber GetFluidRHSInTime im DAESolver aufrufen (nach erneuter</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment">//                // Assemblierung der aktuellen Massematrix) ist das kein Problem.</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="comment">//                // we move the code below to calculateNonLinResidual</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="comment">//                this-&gt;reAssemble(&quot;MoveMesh&quot;);</span></div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="comment">//                MatrixPtr_Type massmatrix;</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;<span class="comment">//                this-&gt;reAssemble(massmatrix, &quot;GetFluidMassmatrix&quot;);</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="comment">//                this-&gt;systemMass_-&gt;addBlock( massmatrix, 0, 0 );</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="comment">//            }</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="comment">//            if(!type.compare(&quot;Extrapolation&quot;)) // if(&quot;Extrapolation&quot;). Ist ehrlich gesagt nur sinnvoll, wenn auch if(geometryExplicit)</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;<span class="comment">//            {</span></div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;<span class="comment">//                nonLinProb-&gt;reAssembleExtrapolation( solutionPreviousTimesteps_ );</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="comment">//            }</span></div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;<span class="comment">//            else if( geometryExplicit &amp;&amp; (!type.compare(&quot;FixedPoint&quot;) || !type.compare(&quot;Newton&quot;) || !type.compare(&quot;NOX&quot;) ) )</span></div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="comment">//            {</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="comment">//                TEUCHOS_TEST_FOR_EXCEPTION(!type.compare(&quot;FixedPoint&quot;), std::runtime_error, &quot;we dont want to assemble fixed point system here. They should always already be assemble by calculatedNonLinResidual().&quot;)</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;<span class="comment">//                nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="comment">//                this-&gt;combineSystems();</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="comment">//                // ACHTUNG: Bei Newton und Fixpunkt wird im geometrisch impliziten Fall</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="comment">//                // problemFluid-&gt;assemble() aufgerufen, was aufgrund von initializeVectors()</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="comment">//                // den Loesungsvektor auf Null setzt. Dies wollen wir hiermit beheben.</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="comment">//    //            if(!geometryExplicit)</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment">//    //            {</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="comment">//    //                nonLinearProblem_-&gt;reAssemble(&quot;SetPartialSolutions&quot;);</span></div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;<span class="comment">//    //            }</span></div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment">//            }</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment">//        }// not FSI</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">//        else{</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment">//            NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment">//            TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, &quot;Nonlinear problem is null.&quot;);</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="comment">//            if(!type.compare(&quot;Extrapolation&quot;) || !type.compare(&quot;FixedPoint&quot;) || !type.compare(&quot;Newton&quot;) || !type.compare(&quot;NOX&quot;)) {</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="comment">//                if (!type.compare(&quot;Extrapolation&quot;))</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="comment">//                    nonLinProb-&gt;reAssembleExtrapolation( solutionPreviousTimesteps_ );</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment">//                else</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">//                    nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="comment">//                std::string timestepping = parameterList_-&gt;sublist(&quot;Timestepping Parameter&quot;).get(&quot;Class&quot;,&quot;Singlestep&quot;);</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="comment">//                if (timestepping==&quot;External&quot;)</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="comment">//                    this-&gt;systemCombined_ = problem_-&gt;getSystem();</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment">//                else</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="comment">//                    this-&gt;combineSystems();</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="comment">//            }</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="comment">//            else {</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="comment">//                TEUCHOS_TEST_FOR_EXCEPTION(true, std::runtime_error, &quot;Unknown reassembly type.&quot;);</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;<span class="comment">//            }</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    </div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    </div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;}</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160; </div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="comment">//template&lt;class SC,class LO,class GO,class NO&gt;</span></div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="comment">//void TimeProblem&lt;SC,LO,GO,NO&gt;::reAssemble(std::string type) const {</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="comment">//    // Fuer FSI</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment">//    if(this-&gt;parameterList_-&gt;sublist(&quot;Parameter&quot;).get(&quot;FSI&quot;,false))</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment">//    {</span></div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;<span class="comment">//        bool geometryExplicit = this-&gt;parameterList_-&gt;sublist(&quot;Parameter&quot;).get(&quot;Geometry Explicit&quot;,true);</span></div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;<span class="comment">//        NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;<span class="comment">//        TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, &quot;FSI problem is null.&quot;);</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;<span class="comment">//        if (!type.compare(&quot;UpdateMeshDisplacement&quot;))</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="comment">//        {</span></div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;<span class="comment">//            nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="comment">//            return;</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="comment">//        else if (!type.compare(&quot;ForTime&quot;))</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="comment">//        {</span></div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="comment">//            nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="comment">//            return;</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;<span class="comment">//        else if (!type.compare(&quot;SolveGeometryProblem&quot;))</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">//        {</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">//            nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="comment">//            return;</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="comment">//        else if (!type.compare(&quot;UpdateTime&quot;))</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;<span class="comment">//        {</span></div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;<span class="comment">//            nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;<span class="comment">//            return;</span></div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;<span class="comment">//        else if (!type.compare(&quot;UpdateFluidInTime&quot;))</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="comment">//        {</span></div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;<span class="comment">//            nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;<span class="comment">//            return;</span></div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="comment">//        else if (!type.compare(&quot;MoveMesh&quot;))</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;<span class="comment">//        {</span></div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="comment">//            nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="comment">//            return;</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;<span class="comment">//        else if (!type.compare(&quot;AddInterfaceBlockRHS&quot;))</span></div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="comment">//        {</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment">//            nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="comment">//            return;</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="comment">//        else if(!type.compare(&quot;ComputeFluidRHSInTime&quot;)){</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;<span class="comment">//            nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;<span class="comment">//            return;</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="comment">//        else if(!type.compare(&quot;ComputeSolidRHSInTime&quot;)){</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment">//            nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="comment">//            return;</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="comment">//        else if(!geometryExplicit &amp;&amp; ( !type.compare(&quot;FixedPoint&quot;) || !type.compare(&quot;Newton&quot;) || !type.compare(&quot;NOX&quot;)) )</span></div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">//        {</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="comment">//            // TODO: Brauchen wir irgendwann einmal, wenn wir Fluid:: oder</span></div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="comment">//            // Struktur::reAssemble() aufrufen:</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">//            // this-&gt;reAssemble(&quot;SetPartialSolutions&quot;);</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="comment">//            // rhs ist fix innerhalb eines Zeitschritts, da nur alter</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="comment">//            // Zeitschritt genutzt wird. Nur Massematrix neu assemblieren.</span></div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="comment">//            // ACHTUNG: Bei SetFluidMassematrix wird auch immer</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="comment">//            // systemMass_ von timeProblemFluid_ ueberschrieben!</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;<span class="comment">//            // Da wir aber GetFluidRHSInTime im DAESolver aufrufen (nach erneuter</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment">//            // Assemblierung der aktuellen Massematrix) ist das kein Problem.</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;<span class="comment">//            // we move the code below to calculateNonLinResidual</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="comment">//            this-&gt;reAssemble(&quot;MoveMesh&quot;);</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="comment">//            MatrixPtr_Type massmatrix;</span></div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;<span class="comment">//            this-&gt;reAssemble(massmatrix, &quot;GetFluidMassmatrix&quot;);</span></div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">//            this-&gt;systemMass_-&gt;addBlock( massmatrix, 0, 0 );</span></div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="comment">//        if(!type.compare(&quot;Extrapolation&quot;)) // if(&quot;Extrapolation&quot;). Ist ehrlich gesagt nur sinnvoll, wenn auch if(geometryExplicit)</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;<span class="comment">//        {</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;<span class="comment">//            nonLinProb-&gt;reAssembleExtrapolation( solutionPreviousTimesteps_ );</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="comment">//        else if( geometryExplicit &amp;&amp; (!type.compare(&quot;FixedPoint&quot;) || !type.compare(&quot;Newton&quot;) || !type.compare(&quot;NOX&quot;) ) )</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment">//        {</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="comment">//            TEUCHOS_TEST_FOR_EXCEPTION(!type.compare(&quot;FixedPoint&quot;), std::runtime_error, &quot;we dont want to assemble fixed point system here. They should always already be assemble by calculatedNonLinResidual().&quot;)</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;<span class="comment">//            nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">//            this-&gt;combineSystems();</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment">//            // ACHTUNG: Bei Newton und Fixpunkt wird im geometrisch impliziten Fall</span></div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment">//            // problemFluid-&gt;assemble() aufgerufen, was aufgrund von initializeVectors()</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="comment">//            // den Loesungsvektor auf Null setzt. Dies wollen wir hiermit beheben.</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment"></span><span class="comment">//        }</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment">//    }</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="comment">//    else{</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="comment">//        NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="comment">//        TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, &quot;Nonlinear problem is null.&quot;);</span></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="comment">//        if(!type.compare(&quot;Extrapolation&quot;) || !type.compare(&quot;FixedPoint&quot;) || !type.compare(&quot;Newton&quot;) || !type.compare(&quot;NOX&quot;)) {</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="comment">//            if (!type.compare(&quot;Extrapolation&quot;))</span></div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="comment">//                nonLinProb-&gt;reAssembleExtrapolation( solutionPreviousTimesteps_ );</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;<span class="comment">//            else</span></div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="comment">//                nonLinProb-&gt;reAssemble(type);</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment">//            std::string timestepping = parameterList_-&gt;sublist(&quot;Timestepping Parameter&quot;).get(&quot;Class&quot;,&quot;Singlestep&quot;);</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment">//            if (timestepping==&quot;External&quot;)</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="comment">//                this-&gt;systemCombined_ = problem_-&gt;getSystem();</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment">//            else</span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">//                this-&gt;combineSystems();</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;<span class="comment">//        else {</span></div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="comment">//            TEUCHOS_TEST_FOR_EXCEPTION(true, std::runtime_error, &quot;Unknown reassembly type.&quot;);</span></div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="comment">//        }</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;<span class="comment">//    }</span></div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="comment">//}</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160; </div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="comment">//template&lt;class SC,class LO,class GO,class NO&gt;</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;<span class="comment">//void TimeProblem&lt;SC,LO,GO,NO&gt;::assembleExternal( std::string type ) const{</span></div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="comment">//    // We use this function to set the previous solution to the (non-)linear problem. This is needed for systems which are completly assembled in class FE</span></div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="comment">//    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</span></div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="comment">//    if ( !nonLinProb.is_null() )</span></div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="comment">//        nonLinProb-&gt;assemble( type );</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;<span class="comment">//    else</span></div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="comment">//        problem_-&gt;assemble( type );</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;<span class="comment">//    if (  type == &quot;Assemble&quot; || type == &quot;AssembleAndUpdate&quot;)</span></div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="comment">//        this-&gt;systemCombined_ = problem_-&gt;getSystem();</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="comment">//};</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160; </div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;<span class="comment">//template&lt;class SC,class LO,class GO,class NO&gt;</span></div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="comment">//void TimeProblem&lt;SC,LO,GO,NO&gt;::reAssemble( MatrixPtr_Type&amp; massmatrix, std::string type ) const</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;<span class="comment">//{</span></div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;<span class="comment">//    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</span></div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="comment">//    // Should only be used by FSI</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="comment">//    nonLinProb-&gt;reAssemble( massmatrix, type );</span></div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="comment">//}</span></div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160; </div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160; </div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::reAssembleAndFill( BlockMatrixPtr_Type bMat, std::string type ){</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160; </div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    nonLinProb-&gt;reAssembleAndFill( bMat, type );</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;}</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160; </div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::combineSystems()<span class="keyword"> const</span>{</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160; </div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;    BlockMatrixPtr_Type tmpSystem = problem_-&gt;getSystem();</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <span class="keywordtype">int</span> size = tmpSystem-&gt;size();</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160; </div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    systemCombined_.reset( <span class="keyword">new</span> BlockMatrix_Type ( size ) );</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160; </div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;size; i++) {</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;        DomainConstPtr_Type dom = this-&gt;getDomain(i);</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;size; j++) {</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;            <span class="keywordflow">if</span> ( tmpSystem-&gt;blockExists(i,j) ) {</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;                LO maxNumEntriesPerRow = tmpSystem-&gt;getBlock(i,j)-&gt;getGlobalMaxNumRowEntries();</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;                MatrixPtr_Type matrix = Teuchos::rcp( <span class="keyword">new</span> Matrix_Type( tmpSystem-&gt;getBlock(i,j)-&gt;getMap(), maxNumEntriesPerRow ) );</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;                </div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;                systemCombined_-&gt;addBlock( matrix, i, j );</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;            }</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span> (systemMass_-&gt;blockExists(i,j)) {</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;                LO maxNumEntriesPerRow = systemMass_-&gt;getBlock(i,j)-&gt;getGlobalMaxNumRowEntries();</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;                MatrixPtr_Type matrix = Teuchos::rcp( <span class="keyword">new</span> Matrix_Type( systemMass_-&gt;getBlock(i,j)-&gt;getMap(), maxNumEntriesPerRow ) );</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;                systemCombined_-&gt;addBlock( matrix, i, j );</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;            }</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;        }</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    }</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160; </div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    SmallMatrix&lt;SC&gt; ones( size , Teuchos::ScalarTraits&lt;SC&gt;::one());</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;    SmallMatrix&lt;SC&gt; zeros( size , Teuchos::ScalarTraits&lt;SC&gt;::zero());</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    systemMass_-&gt;addMatrix( massParameters_, systemCombined_, zeros );</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    tmpSystem-&gt;addMatrix( timeParameters_, systemCombined_, ones );</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    </div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;size; i++) {</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;size; j++) {</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;            <span class="keywordflow">if</span> ( systemCombined_-&gt;blockExists(i,j) ) {</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;                <span class="keywordflow">if</span> ( tmpSystem-&gt;blockExists(i,j) ) {</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;                    MatrixPtr_Type matrix = tmpSystem-&gt;getBlock(i,j);</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;                    MatrixConstPtr_Type matrixConstComb = systemCombined_-&gt;getBlock(i,j);</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;                    MatrixPtr_Type matrixComb = Teuchos::rcp_const_cast&lt;Matrix_Type&gt;(matrixConstComb);</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;                    matrixComb-&gt;fillComplete( matrix-&gt;getMap(<span class="stringliteral">&quot;domain&quot;</span>), matrix-&gt;getMap(<span class="stringliteral">&quot;range&quot;</span>) );</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;                }</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;                <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( systemMass_-&gt;blockExists(i,j) ) {</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;                    MatrixPtr_Type matrix = systemMass_-&gt;getBlock(i,j);</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;                    MatrixConstPtr_Type matrixConstComb = systemCombined_-&gt;getBlock(i,j);</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;                    MatrixPtr_Type matrixComb = Teuchos::rcp_const_cast&lt;Matrix_Type&gt;(matrixConstComb);</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;                    matrixComb-&gt;fillComplete( matrix-&gt;getMap(<span class="stringliteral">&quot;domain&quot;</span>), matrix-&gt;getMap(<span class="stringliteral">&quot;range&quot;</span>) );</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;                }</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;                <span class="keywordflow">else</span></div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;                    TEUCHOS_TEST_FOR_EXCEPTION( <span class="keyword">true</span>, std::runtime_error,<span class="stringliteral">&quot;TimeProblem: Combined systems possess a block which does not exist in partial systems.&quot;</span>);</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;            }</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;        }</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    }</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;}</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160; </div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::updateRhs(){</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160; </div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    systemMass_-&gt;apply( *solutionPreviousTimesteps_[0], *problem_-&gt;getRhs(), massParameters_ );</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;}</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160; </div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::updateMultistepRhs(vec_dbl_Type&amp; coeff, <span class="keywordtype">int</span> nmbToUse){</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160; </div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    problem_-&gt;getRhs()-&gt;putScalar(0.);</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160; </div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;    <span class="keywordtype">int</span> size = massParameters_.size();</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160; </div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;nmbToUse; i++) {</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        SmallMatrix&lt;SC&gt; tmpMassParameter(size);</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> r=0; r&lt;size; r++) {</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s=0; s&lt;size; s++) {</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;                <span class="keywordflow">if</span> (massParameters_[r][s]!=0.)</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;                    tmpMassParameter[r][s] = coeff[i];</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;            }</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;        }</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;        BlockMultiVectorPtr_Type tmpVector</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;            = Teuchos::rcp( <span class="keyword">new</span> BlockMultiVector_Type( problem_-&gt;getRhs() ) );</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;        BlockMultiVectorPtr_Type tmpBlockVector = solutionPreviousTimesteps_[i];</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;        systemMass_-&gt;apply( *tmpBlockVector, *tmpVector, tmpMassParameter );</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        problem_-&gt;getRhs()-&gt;update( 1., tmpVector, 1. );</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;    }</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160; </div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;}</div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160; </div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160; </div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::updateMultistepRhsFSI(vec_dbl_Type&amp; coeff, <span class="keywordtype">int</span> nmbToUse){</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160; </div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;    problem_-&gt;getRhs()-&gt;putScalar(0.);</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160; </div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    <span class="keywordtype">int</span> size = massParameters_.size();</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160; </div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;nmbToUse; i++) {</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;        SmallMatrix&lt;SC&gt; tmpMassParameter(size);</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> r=0; r&lt;size; r++) {</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> s=0; s&lt;size; s++) {</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;                <span class="keywordflow">if</span> (massParameters_[r][s]!=0.) {</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;                    tmpMassParameter[r][s] = coeff[i];</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;                }</div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160; </div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;            }</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;        }</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;        BlockMultiVectorPtr_Type tmpVector</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;            = Teuchos::rcp( <span class="keyword">new</span> BlockMultiVector_Type( problem_-&gt;getRhs() ) );</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;        BlockMultiVectorPtr_Type tmpBlockVector = solutionPreviousTimesteps_[i];</div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;        systemMassPreviousTimeSteps_[i]-&gt;apply( *tmpBlockVector, *tmpVector, tmpMassParameter );</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;        problem_-&gt;getRhs()-&gt;update( 1., tmpVector, 1. );</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;    }</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160; </div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;}</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160; </div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160; </div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="comment">// Stelle die rechte Seite des zeitdiskretisierten Systems auf (ohne f_{n+1}).</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;<span class="comment">// Bei Newmark lautet dies:</span></div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="comment">// M*[\frac{1}{dt^2*beta}*u_n + \frac{1}{dt*beta}*u&#39;_n + \frac{0.5 - beta}{beta}*u&#39;&#39;_n],</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;<span class="comment">// wobei u&#39; = v (velocity) und u&#39;&#39; = w (acceleration).</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::updateNewmarkRhs(<span class="keywordtype">double</span> dt, <span class="keywordtype">double</span> beta, <span class="keywordtype">double</span> gamma, vec_dbl_Type coeff)</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;{</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    <span class="comment">// ######################</span></div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;    <span class="comment">// Wir reseten die rechte Seite (beim ersten Schritt ist dies die rechte Seite der DGL [= SourceTerm] und</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    <span class="comment">// spaeter ist es dann die rechte Seite des zeitintegrierten System aus dem vorherigen Zeitschritt)</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    <span class="comment">// und fuegen alle noetigen Terme bis auf den SourceTerm hinzu.</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;    <span class="comment">// Der SourceTerm wir in AdvanceInTime() hinzuaddiert.</span></div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="comment">// BEACHTE: Bei Struktur gibt es nur einen Block, z.B. tempVector1[0].</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    <span class="comment">// ######################</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160; </div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;    <span class="comment">// Temperaerer Vektor fuer die Vektoradditionen in der rechte Seite.</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    <span class="comment">// ACHTUNG: BlockMultiVector_Type tempVector1(*(solutionPreviousTimesteps_.at(0)))</span></div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;    <span class="comment">// veraendert solutionPreviousTimesteps_.at(0)!!! NICHT NUTZEN!!!</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;    BlockMultiVectorPtrArray_Type tempVector1(1);</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;    <span class="comment">// tempVector1 = u_n (in der neuen Zeiteration)</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    tempVector1.at(0) = Teuchos::rcp(<span class="keyword">new</span> BlockMultiVector_Type(solutionPreviousTimesteps_.at(0)));</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160; </div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    <span class="comment">// tempVector1 = \frac{1}{dt^2*beta}*u_n</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    tempVector1.at(0)-&gt;scale(1.0/(dt*dt*beta));</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160; </div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;    <span class="comment">// tempVector1 = tempVector1 + \frac{1}{dt*beta}*u&#39;_n + \frac{0.5 - beta}{beta}*u&#39;&#39;_n</span></div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    tempVector1.at(0)-&gt;update(1.0/(dt*beta), *(velocityPreviousTimesteps_[0]), (0.5 - beta)/beta, *(accelerationPreviousTimesteps_[0]), 1.0);</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160; </div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160; </div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;    <span class="comment">// In tempVector2 steht dann das Endergebniss am Ende.</span></div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    <span class="comment">// Siehe ACHTUNG von oben.</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    BlockMultiVectorPtrArray_Type tempVector2(1);</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    tempVector2.at(0) = Teuchos::rcp(<span class="keyword">new</span> BlockMultiVector_Type(solutionPreviousTimesteps_.at(0)));</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160; </div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    <span class="comment">// Koeffizient, um die mit \frac{rho}{dt^2*beta} skalierte Massematrix wieder zur Normalen zur machen</span></div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;    <span class="comment">// Skalierung mit \rho ist allerdings notwendig!</span></div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;    <span class="keywordtype">int</span> size = massParameters_.size();</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    SmallMatrix&lt;double&gt; tmpMassParameter(size);</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> r = 0; r &lt; size; r++)</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    {</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> s = 0; s &lt; size; s++)</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;        {</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;            <span class="keywordflow">if</span>(massParameters_[r][s] != 0.0)</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;            {</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;                tmpMassParameter[r][s] = coeff.at(0);</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;            }</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160; </div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;        }</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;    }</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160; </div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;    <span class="comment">// tempVector2 = tmpMassParameter.*M*tempVector1</span></div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;    systemMass_-&gt;apply(*(tempVector1.at(0)), *(tempVector2.at(0)), tmpMassParameter);</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160; </div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;    <span class="comment">// RHS = 0*RHS + 1.0*tempVector2</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;    problem_-&gt;getRhs()-&gt;update(1.0, *(tempVector2.at(0)), .0);</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160; </div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;}</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160; </div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160; </div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::BlockMultiVectorPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getSolution(){</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160; </div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    <span class="keywordflow">return</span> problem_-&gt;getSolution();</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;}</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;    </div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::BlockMultiVectorConstPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getSolutionConst()<span class="keyword"> const </span>{</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;    <span class="keywordflow">return</span> problem_-&gt;getSolution();</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;}</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160; </div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::BlockMultiVectorPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getResidual(){</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;    </div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, <span class="stringliteral">&quot;Nonlinear problem is null.&quot;</span>);</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;    <span class="keywordflow">return</span> nonLinProb-&gt;getResidualVector ();</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;}</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    </div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::BlockMultiVectorConstPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getResidualConst()<span class="keyword"> const</span>{</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    </div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, <span class="stringliteral">&quot;Nonlinear problem is null.&quot;</span>);</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    <span class="keywordflow">return</span> nonLinProb-&gt;getResidualVector ();</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;}</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;    </div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::BlockMultiVectorPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getSolutionPreviousTimestep(){</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160; </div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    <span class="keywordflow">return</span> solutionPreviousTimesteps_[0];</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;}</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160; </div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::BlockMultiVectorPtrArray_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getSolutionAllPreviousTimestep(){</div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160; </div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    <span class="keywordflow">return</span> solutionPreviousTimesteps_;</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;}</div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160; </div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::initializeCombinedSystems()<span class="keyword"> const</span>{</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160; </div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;    BlockMatrixConstPtr_Type blockMatrixProblem = problem_-&gt;getSystem();</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160; </div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;    <span class="keywordtype">int</span> size = blockMatrixProblem-&gt;size();</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160; </div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;size; i++) {</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;size; j++) {</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;            MatrixPtr_Type matrix;</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;            <span class="keywordtype">bool</span> foundMatrix = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;            <span class="keywordflow">if</span> ( blockMatrixProblem-&gt;blockExists(i,j) ) {</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;                MatrixConstPtr_Type matrixProblem = blockMatrixProblem-&gt;getBlockConst(i,j);</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;                MapConstPtr_Type map = matrixProblem-&gt;getMap();</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;                MapPtr_Type mapNonConst = Teuchos::rcp_const_cast&lt;Map_Type&gt; (map);</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;                matrix = Teuchos::rcp( <span class="keyword">new</span> Matrix_Type( mapNonConst, matrixProblem-&gt;getGlobalMaxNumRowEntries() ) ); <span class="comment">//We should build matrices with graphs!</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;                foundMatrix = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;            }</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;            <span class="keywordflow">else</span> <span class="keywordflow">if</span>( systemMass_-&gt;blockExists(i,j) &amp;&amp; !foundMatrix ){</div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;                MatrixConstPtr_Type matrixMass = systemMass_-&gt;getBlockConst(i,j);</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;                MapConstPtr_Type map = matrixMass-&gt;getMap();</div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;                MapPtr_Type mapNonConst = Teuchos::rcp_const_cast&lt;Map_Type&gt; (map);</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;                matrix = Teuchos::rcp( <span class="keyword">new</span> Matrix_Type( mapNonConst, matrixMass-&gt;getGlobalMaxNumRowEntries() ) ); <span class="comment">//We should build matrices with graphs!</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;                foundMatrix = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;            }</div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;            <span class="keywordflow">if</span> (foundMatrix)</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;                systemCombined_-&gt;addBlock( matrix, i, j );</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160; </div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;        }</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;    }</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;}</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160; </div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::assembleMassSystem( )<span class="keyword"> const </span>{</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160; </div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;    ProblemPtr_Type tmpProblem;</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;    SC eps100 = 100.*Teuchos::ScalarTraits&lt;SC&gt;::eps();</div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160; </div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;    <span class="comment">// Die Massematrix wird noch mit der Dichte \rho skaliert</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    <span class="keywordtype">double</span> density = parameterList_-&gt;sublist(<span class="stringliteral">&quot;Parameter&quot;</span>).get(<span class="stringliteral">&quot;Density&quot;</span>,1.);</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160; </div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;    <span class="keywordtype">int</span> size = problem_-&gt;getSystem()-&gt;size();</div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;    systemMass_-&gt;resize( size );</div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    <span class="keywordtype">int</span> dofsPerNode;</div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;size; i++ ) {</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160; </div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;        dofsPerNode = problem_-&gt;getDofsPerNode(i);</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;        MatrixPtr_Type M;</div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;        <span class="keywordflow">if</span> ( timeStepDef_[i][i]&gt;0 ) {</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;            <span class="keywordflow">if</span> (dofsPerNode&gt;1) {</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;                M = Teuchos::rcp(<span class="keyword">new</span> Matrix_Type( this-&gt;getDomain(i)-&gt;getMapVecFieldUnique(), this-&gt;getDomain(i)-&gt;getApproxEntriesPerRow() ) );</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;                feFactory_-&gt;assemblyMass(dimension_, problem_-&gt;getFEType(i), <span class="stringliteral">&quot;Vector&quot;</span>, M, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160; </div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;                M-&gt;resumeFill();</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;                M-&gt;scale(density);</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;                M-&gt;fillComplete( this-&gt;getDomain(i)-&gt;getMapVecFieldUnique(), this-&gt;getDomain(i)-&gt;getMapVecFieldUnique());</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160; </div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;                systemMass_-&gt;addBlock(M, i, i);</div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;            }</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;            <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;                M = Teuchos::rcp(<span class="keyword">new</span> Matrix_Type( this-&gt;getDomain(i)-&gt;getMapUnique(), this-&gt;getDomain(i)-&gt;getApproxEntriesPerRow() ) );</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;                feFactory_-&gt;assemblyMass(dimension_, problem_-&gt;getFEType(i), <span class="stringliteral">&quot;Scalar&quot;</span>, M, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160; </div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;                M-&gt;resumeFill();</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;                M-&gt;scale(density);</div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;                M-&gt;fillComplete( this-&gt;getDomain(i)-&gt;getMapUnique(), this-&gt;getDomain(i)-&gt;getMapUnique());</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160; </div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;                systemMass_-&gt;addBlock(M, i, i);</div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;            }</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;        }</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;size; j++) {</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;                <span class="keywordflow">if</span> (timeStepDef_[i][j]==2) {</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;                    <span class="keywordflow">if</span> (dofsPerNode&gt;1) {</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;                        M = Teuchos::rcp(<span class="keyword">new</span> Matrix_Type( this-&gt;getDomain(i)-&gt;getMapVecFieldUnique(), this-&gt;getDomain(i)-&gt;getApproxEntriesPerRow() ) );</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;                        feFactory_-&gt;assemblyMass(dimension_, problem_-&gt;getFEType(i), <span class="stringliteral">&quot;Vector&quot;</span>, M, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;                        </div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;                        M-&gt;resumeFill();</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;                        M-&gt;scale(density);</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;                        M-&gt;fillComplete( this-&gt;getDomain(i)-&gt;getMapVecFieldUnique(), this-&gt;getDomain(i)-&gt;getMapVecFieldUnique());</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;                        </div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;                        systemMass_-&gt;addBlock(M, i, j);</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;                    }</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;                    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;                        M = Teuchos::rcp(<span class="keyword">new</span> Matrix_Type( this-&gt;getDomain(i)-&gt;getMapUnique(), this-&gt;getDomain(i)-&gt;getApproxEntriesPerRow() ) );</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;                        feFactory_-&gt;assemblyMass(dimension_, problem_-&gt;getFEType(i), <span class="stringliteral">&quot;Scalar&quot;</span>, M, <span class="keyword">true</span>);</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;                        </div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;                        M-&gt;resumeFill();</div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;                        M-&gt;scale(density);</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;                        M-&gt;fillComplete( this-&gt;getDomain(i)-&gt;getMapUnique(), this-&gt;getDomain(i)-&gt;getMapUnique());</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;                        </div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;                        systemMass_-&gt;addBlock(M, i, j);</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;                    }</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;                }</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;            }</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;        }</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;    }</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;}</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160; </div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::setTimeParameters(SmallMatrix&lt;double&gt; &amp;massParameters, SmallMatrix&lt;double&gt; &amp;timeParameters){</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160; </div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    timeParameters_ = timeParameters;</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160; </div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;    massParameters_ = massParameters;</div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160; </div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;}</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160; </div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;<span class="keywordtype">bool</span> TimeProblem&lt;SC,LO,GO,NO&gt;::getVerbose(){</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160; </div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    <span class="keywordflow">return</span> verbose_;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;}</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160; </div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="keywordtype">double</span> TimeProblem&lt;SC,LO,GO,NO&gt;::calculateResidualNorm(){</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160; </div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, <span class="stringliteral">&quot;Nonlinear problem is null.&quot;</span>);</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    </div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;    Teuchos::Array&lt;SC&gt; res(1);</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;    nonLinProb-&gt;getResidualVector()-&gt;norm2(res);</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160; </div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;    <span class="keywordflow">return</span> res[0];</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;}</div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160; </div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::calculateNonLinResidualVec( std::string type, <span class="keywordtype">double</span> time )<span class="keyword"> const</span>{</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160; </div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, <span class="stringliteral">&quot;Nonlinear problem is null.&quot;</span>);</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;    </div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;    <span class="keywordflow">if</span> (type == <span class="stringliteral">&quot;external&quot;</span>) { <span class="comment">// we get the complete residual from AceGEN</span></div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;        nonLinProb-&gt;calculateNonLinResidualVec( <span class="stringliteral">&quot;external&quot;</span> );</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;    }</div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;        <span class="comment">// rhs and sourceterm is accounted for in calculateNonLinResidualVec.</span></div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;        <span class="comment">// rhs must bet assembled (computed) correctly in DAESolver (e.g. M/dt*u_t). sourceterm aswell</span></div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;        nonLinProb-&gt;calculateNonLinResidualVec( timeParameters_ ,type, time );</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160; </div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;        <span class="comment">// for FSI we need to reassemble the massmatrix system if the mesh was moved for geometry implicit computations</span></div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;        <span class="keywordflow">if</span> (this-&gt;parameterList_-&gt;sublist(<span class="stringliteral">&quot;Parameter&quot;</span>).get(<span class="stringliteral">&quot;FSI&quot;</span>,<span class="keyword">false</span>) ){</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;            <span class="keywordtype">bool</span> geometryExplicit = this-&gt;parameterList_-&gt;sublist(<span class="stringliteral">&quot;Parameter&quot;</span>).get(<span class="stringliteral">&quot;Geometry Explicit&quot;</span>,<span class="keyword">true</span>);</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;            <span class="keywordflow">if</span>( !geometryExplicit ) {</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;                <span class="keyword">typedef</span> FSI&lt;SC,LO,GO,NO&gt; FSI_Type;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;                <span class="keyword">typedef</span> Teuchos::RCP&lt;FSI_Type&gt; FSIPtr_Type;</div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;                </div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;                MatrixPtr_Type massmatrix;                </div>
<div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;                FSIPtr_Type fsi = Teuchos::rcp_dynamic_cast&lt;FSI_Type&gt;( this-&gt;problem_ );</div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;                fsi-&gt;setFluidMassmatrix( massmatrix );</div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;                this-&gt;systemMass_-&gt;addBlock( massmatrix, 0, 0 );</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;            }</div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;        }</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;        <span class="comment">// we need to add M/dt*u_(t+1)^k (the last results of the nonlinear method) to the residualVec_</span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;        <span class="comment">//Copy</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;        BlockMultiVectorPtr_Type tmpMV = Teuchos::rcp(<span class="keyword">new</span> BlockMultiVector_Type( nonLinProb-&gt;getSolution() ) );</div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;        tmpMV-&gt;putScalar(0.);</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;        </div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;        systemMass_-&gt;apply( *nonLinProb-&gt;getSolution(), *tmpMV, massParameters_ );</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160; </div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;        <span class="keywordflow">if</span> (type==<span class="stringliteral">&quot;reverse&quot;</span>)<span class="comment">// reverse: b-Ax</span></div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;            nonLinProb-&gt;getResidualVector()-&gt;update(-1,*tmpMV,1.);<span class="comment">//this=1.*this + -1.*tmpMV</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(type==<span class="stringliteral">&quot;standard&quot;</span>)<span class="comment">// standard: Ax-b</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;            nonLinProb-&gt;getResidualVector()-&gt;update(1,*tmpMV,1.);</div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;            TEUCHOS_TEST_FOR_EXCEPTION( <span class="keyword">true</span>, std::runtime_error, <span class="stringliteral">&quot;Unkown type to compute the residual for a time problem.&quot;</span>);</div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;        </div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;        <span class="keywordflow">if</span> (type==<span class="stringliteral">&quot;reverse&quot;</span>)<span class="comment">// we set the Dirichlet BC to the residual</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;            this-&gt;bcFactory_-&gt;setBCMinusVector( nonLinProb-&gt;getResidualVector(), nonLinProb-&gt;getSolution(), time );</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span>(type==<span class="stringliteral">&quot;standard&quot;</span>)<span class="comment">// we set the negative Dirichlet BC to the residual</span></div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;            this-&gt;bcFactory_-&gt;setVectorMinusBC( nonLinProb-&gt;getResidualVector(), nonLinProb-&gt;getSolution(), time );</div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;            </div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    }</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160; </div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    </div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;}</div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160; </div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::setBoundaries(<span class="keywordtype">double</span> time){</div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160; </div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    BlockMultiVectorPtr_Type tmpRhs = problem_-&gt;getRhs();</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160; </div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    bcFactory_-&gt;set( systemCombined_, tmpRhs, time );</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;}</div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160; </div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::setBoundariesRHS(<span class="keywordtype">double</span> time){</div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160; </div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;    BlockMultiVectorPtr_Type tmpRhs = problem_-&gt;getRhs();</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160; </div>
<div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;    bcFactory_-&gt;setRHS( tmpRhs, time );</div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;}</div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160; </div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::setBoundariesSystem()<span class="keyword"> const</span>{</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160; </div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    bcFactory_-&gt;setSystem(systemCombined_);</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160; </div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;}</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160; </div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;<span class="keywordtype">int</span> TimeProblem&lt;SC,LO,GO,NO&gt;::solveUpdate(  ){</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160; </div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, <span class="stringliteral">&quot;Nonlinear problem is null.&quot;</span>);</div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;    </div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;    *nonLinProb-&gt;previousSolution_ = *nonLinProb-&gt;getSolution();</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160; </div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;    <span class="keywordtype">int</span> its = this-&gt;solve( nonLinProb-&gt;residualVec_ );</div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160; </div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;    <span class="keywordflow">return</span> its;</div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;}</div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160; </div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;<span class="keywordtype">int</span> TimeProblem&lt;SC,LO,GO,NO&gt;::solveAndUpdate( <span class="keyword">const</span> std::string&amp; criterion, <span class="keywordtype">double</span>&amp; criterionValue ){</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160; </div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, <span class="stringliteral">&quot;Nonlinear problem is null.&quot;</span>);</div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;    </div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;    <span class="keywordtype">int</span> its = solveUpdate(  );</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160; </div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;    <span class="keywordflow">if</span> (criterion==<span class="stringliteral">&quot;Update&quot;</span>) {</div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;        Teuchos::Array&lt;SC&gt; updateNorm(1);</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;        nonLinProb-&gt;getSolution()-&gt;norm2(updateNorm());</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;        criterionValue = updateNorm[0];</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;    }</div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;    <span class="keywordflow">if</span> (criterion==<span class="stringliteral">&quot;ResidualAceGen&quot;</span>) {</div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;        nonLinProb-&gt;getSolution()-&gt;update( 1., *nonLinProb-&gt;previousSolution_, -1. );</div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;        nonLinProb-&gt;assemble( <span class="stringliteral">&quot;SetSolutionNewton&quot;</span> );</div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;        <span class="comment">//nonLinProb-&gt;assembleExternal( &quot;OnlyUpdate&quot; ); // CH 04.06.2020: Ist das richtig?</span></div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;    }</div>
<div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;        nonLinProb-&gt;getSolution()-&gt;update( 1., *nonLinProb-&gt;previousSolution_, 1. );</div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160; </div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;    <span class="comment">//nonLinProb-&gt;getSolution()-&gt;print();</span></div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;    </div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;    <span class="keywordflow">return</span> its;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;}</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160; </div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;<span class="keywordtype">int</span> TimeProblem&lt;SC,LO,GO,NO&gt;::solve( BlockMultiVectorPtr_Type rhs ){</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160; </div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;    <span class="keywordtype">int</span> its;</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;    <span class="keywordflow">if</span> (verbose_)</div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;        std::cout &lt;&lt; <span class="stringliteral">&quot;-- Solve System ...&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;    {</div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;        std::string type = parameterList_-&gt;sublist(<span class="stringliteral">&quot;General&quot;</span>).get(<span class="stringliteral">&quot;Preconditioner Method&quot;</span>,<span class="stringliteral">&quot;Monolithic&quot;</span>);</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;        LinearSolver&lt;SC,LO,GO,NO&gt; linSolver;</div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;        its = linSolver.solve( <span class="keyword">this</span>, rhs, type ); <span class="comment">// if rhs is null. Then the rhs_ of this is used in the linear solver</span></div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;    }</div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;    <span class="keywordflow">if</span> (verbose_)</div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;        std::cout &lt;&lt; <span class="stringliteral">&quot; done. -- &quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160; </div>
<div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;    <span class="keywordflow">return</span> its;</div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;}</div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160; </div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::updateSolutionPreviousStep(){</div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160; </div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;    <span class="keywordflow">if</span> (solutionPreviousTimesteps_.size()==0)</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;        solutionPreviousTimesteps_.resize(1);</div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160; </div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;    solutionPreviousTimesteps_[0] = Teuchos::rcp( <span class="keyword">new</span> BlockMultiVector_Type( problem_-&gt;getSolution() ) );</div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;    </div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;}</div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160; </div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::updateSolutionMultiPreviousStep(<span class="keywordtype">int</span> nmbSteps){</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160; </div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;    <span class="keywordtype">int</span> size = solutionPreviousTimesteps_.size();</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;    <span class="keywordflow">if</span> (size&lt;nmbSteps &amp;&amp;  size &gt; 0) {</div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;        BlockMultiVectorPtr_Type toAddMVreset = Teuchos::rcp( <span class="keyword">new</span> BlockMultiVector_Type( solutionPreviousTimesteps_[size-1] ) );</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;        solutionPreviousTimesteps_.push_back( toAddMVreset );</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    }</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(size == 0)</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;        solutionPreviousTimesteps_.resize(1);</div>
<div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=size-1; i&gt;0; i--)</div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;            solutionPreviousTimesteps_[i] = Teuchos::rcp( <span class="keyword">new</span> BlockMultiVector_Type( solutionPreviousTimesteps_[i-1] ) );</div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;    }</div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;    </div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;    solutionPreviousTimesteps_[0] = Teuchos::rcp( <span class="keyword">new</span> BlockMultiVector_Type( problem_-&gt;getSolution() ) );</div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;    </div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;}</div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160; </div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160; </div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::updateSystemMassMultiPreviousStep(<span class="keywordtype">int</span> nmbSteps){</div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160; </div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;    <span class="keywordtype">int</span> size = systemMassPreviousTimeSteps_.size();</div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;    <span class="keywordflow">if</span> (size&lt;nmbSteps &amp;&amp;  size &gt; 0) {<span class="comment">// only works for BDF2, for BDF3 we would have to adjust below else case</span></div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        BlockMatrixPtr_Type toAddMatrixreset = Teuchos::rcp( <span class="keyword">new</span> BlockMatrix_Type( systemMassPreviousTimeSteps_[size-1] ) );</div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160; </div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;        systemMassPreviousTimeSteps_.push_back( toAddMatrixreset );</div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;    }</div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(size == 0)</div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;        systemMassPreviousTimeSteps_.resize(1);</div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;    <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=size-1; i&gt;0; i--)</div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;            systemMassPreviousTimeSteps_[i] = Teuchos::rcp( <span class="keyword">new</span> BlockMatrix_Type( systemMassPreviousTimeSteps_[i-1] ) );</div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;    }</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160; </div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;    systemMassPreviousTimeSteps_[0] = Teuchos::rcp( <span class="keyword">new</span> BlockMatrix_Type( systemMass_ ) );</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    </div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;}</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160; </div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160; </div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;<span class="comment">// Beachte: Diese Funktion wird zu Beginn jeder time-loop aufgerufen!!!</span></div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::updateSolutionNewmarkPreviousStep(<span class="keywordtype">double</span> dt, <span class="keywordtype">double</span> beta, <span class="keywordtype">double</span> gamma)</div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;{</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    <span class="comment">// ########################</span></div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;    <span class="comment">// Fuer die Newmark-Variable u (displacement)</span></div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    <span class="comment">// ########################</span></div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    <span class="comment">// Zur Berechnung von u&#39;_{n+1} und u&#39;&#39;_{n+1} wird die letzte Loesung u_{n+1} und die Vorherige u_n gebraucht.</span></div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    <span class="comment">// Da wir aber bereits im neuen Zeitschritt sind (vgl. Zeitpunkt des Aufrufs der Funktion), ist u_n = u_{n+1} und u_{n-1} = u_n.</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;    <span class="comment">// Wir benoetigen solutionPreviousTimesteps_ mit zwei Eintraegen.</span></div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;    <span class="keywordtype">int</span> size = solutionPreviousTimesteps_.size();</div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160; </div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;    <span class="keywordflow">if</span>(size &lt; 2 &amp;&amp;  size &gt; 0) <span class="comment">// Sofern der Vektor solutionPreviousTimesteps_ noch nicht komplett belegt ist (bei Newmark benoetigen wir als vergangene Loesung noch u_n)</span></div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;    {</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;        BlockMultiVectorPtr_Type toAddMVreset = Teuchos::rcp(<span class="keyword">new</span> BlockMultiVector_Type(solutionPreviousTimesteps_.at(size-1)));</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;        <span class="comment">// Fuege die z.B. zweite Loesung u_2 hinten drauf, sofern eine vergangene Loesung bei der Zeitintegration gebraucht wird</span></div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;        solutionPreviousTimesteps_.push_back(toAddMVreset);</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    }</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span>(size == 0) <span class="comment">// Falls noch keine alte Loesung vorhanden ist</span></div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;    {</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;        solutionPreviousTimesteps_.resize(1);</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    }</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;    <span class="keywordflow">else</span> <span class="comment">// Verschiebe alle vergangenen Loesungen</span></div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;    {</div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i = size-1; i &gt; 0; i--)</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;        {</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;            solutionPreviousTimesteps_.at(i) = Teuchos::rcp(<span class="keyword">new</span> BlockMultiVector_Type(solutionPreviousTimesteps_.at(i-1)));</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;        }</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160; </div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;    }</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160; </div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    solutionPreviousTimesteps_.at(0) = Teuchos::rcp(<span class="keyword">new</span> BlockMultiVector_Type(problem_-&gt;getSolution()));</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160; </div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    <span class="comment">// Bzgl. der neuen Zeititeration steht am Ende nun an der Stelle 0 die vergangene Loesung u_n und</span></div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    <span class="comment">// an der Stelle die 1 davor, also u_{n-1}. Dies entspricht u_{n+1} und u_n, wenn man u&#39;_{n+1} und</span></div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    <span class="comment">// u&#39;&#39;_{n+1} bereits am Ende der letzten Zeititeration berechnet.</span></div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160; </div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    <span class="comment">// ########################</span></div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;    <span class="comment">// Fuer die Newmark-Variablen u&#39; = v (velocity) und u&#39;&#39; = w (acceleration)</span></div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;    <span class="comment">// ########################</span></div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    <span class="keywordflow">if</span>(velocityPreviousTimesteps_.size() == 0)</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;    {</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;        <span class="comment">// Hier steht noch kein MultiVector drin</span></div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;        velocityPreviousTimesteps_.resize(1);</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;        accelerationPreviousTimesteps_.resize(1);</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160; </div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;        <span class="comment">// Am Anfang haben wir als Startloesung die Nulloesung.</span></div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;        <span class="comment">// Wir wollen als Startwerte ebenso u&#39; = u&#39;&#39; = 0 setzen.</span></div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;        <span class="comment">// Schreibe die Startloesung als MultiVector hinein (damit dort irgendetwas steht) und setze diese dann auf Null</span></div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;        velocityPreviousTimesteps_.at(0) = Teuchos::rcp(<span class="keyword">new</span> BlockMultiVector_Type(problem_-&gt;getSolution()));</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;        accelerationPreviousTimesteps_.at(0) = Teuchos::rcp(<span class="keyword">new</span> BlockMultiVector_Type(problem_-&gt;getSolution()));</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;        velocityPreviousTimesteps_.at(0)-&gt;putScalar(0.0);</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;        accelerationPreviousTimesteps_.at(0)-&gt;putScalar(0.0);</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;    }</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    {</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;        <span class="comment">// ########################</span></div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;        <span class="comment">// u&#39;_{n+1} = \frac{gamma}{dt*beta}*(u_{n+1} - u_n) + (1 - \frac{gamma}{beta})*u&#39;_n + dt*\frac{beta - 0.5*gamma}{beta}*u&#39;&#39;_n, vgl. MA</span></div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;        <span class="comment">// ########################</span></div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160; </div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;        <span class="comment">// Speichere die alte (nicht geupdatete) velocity u&#39;_n fuer die Berechnung von u&#39;&#39;_{n+1} ab.</span></div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;        <span class="comment">// Siehe hier drunter fuer ACHTUNG.</span></div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;        BlockMultiVectorPtrArray_Type velocityOld;</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;        velocityOld.resize(1);</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;        velocityOld.at(0) = Teuchos::rcp(<span class="keyword">new</span> BlockMultiVector_Type(velocityPreviousTimesteps_.at(0)));</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160; </div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160; </div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;        <span class="comment">// Berechne \frac{gamma}{dt*beta}*(u_{n+1} - u_n):</span></div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;        <span class="comment">// ACHTUNG: BlockMultiVector_Type tmpVector1(*(solutionPreviousTimesteps_.at(0)))</span></div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;        <span class="comment">// veraendert solutionPreviousTimesteps_.at(0)!!! NICHT NUTZEN!!!</span></div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;        <span class="comment">// BlockMultiVector_Type tmpVector1(*(solutionPreviousTimesteps_.at(0)));</span></div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;        BlockMultiVectorPtrArray_Type tmpVector1;</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;        tmpVector1.resize(1);</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;        <span class="comment">// tmpVector1 = u_{n+1}</span></div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;        tmpVector1.at(0) = Teuchos::rcp(<span class="keyword">new</span> BlockMultiVector_Type(solutionPreviousTimesteps_.at(0)));</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160; </div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;        <span class="comment">// Funktionsaufruf: Update(ScalarA, A, ScalarThis) =&gt; this = ScalarThis*this + ScalarA*A</span></div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;        tmpVector1.at(0)-&gt;update(-gamma/(dt*beta), *(solutionPreviousTimesteps_.at(1)), gamma/(dt*beta));</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160; </div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;        <span class="comment">// Berechne (1 - \frac{gamma}{beta})*u&#39;_n</span></div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;        velocityPreviousTimesteps_.at(0)-&gt;scale(1.0 - (gamma/beta));</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160; </div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;        <span class="comment">// Addiere noch \tmpVector1 + dt*\frac{beta - 0.5*gamma}{beta}*u&#39;&#39;_n HINZU</span></div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;        <span class="comment">// Funktionsaufruf: Update(ScalarA, A, ScalarB, B, ScalarThis) =&gt; this = ScalarThis*this + ScalarA*A + ScalarB*B</span></div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;        velocityPreviousTimesteps_.at(0)-&gt;update(1.0, *(tmpVector1.at(0)), dt*((beta - 0.5*gamma)/(beta)), *(accelerationPreviousTimesteps_.at(0)), 1.0);</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160; </div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160; </div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;        <span class="comment">// ########################</span></div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;        <span class="comment">// u&#39;&#39;_{n+1} = \frac{1}{dt*dt*beta}*(u_{n+1} - u_n) - \frac{1}{dt*beta})*u&#39;_n - \frac{0.5 - beta}{beta}*u&#39;&#39;_n, vgl. MA</span></div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;        <span class="comment">// ########################</span></div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160; </div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;        <span class="comment">// Berechne \frac{1}{dt*dt*beta}*(u_{n+1} - u_n):</span></div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;        <span class="comment">// Beachte ACHTUNG von oben.</span></div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;        BlockMultiVectorPtrArray_Type tmpVector2;</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;        tmpVector2.resize(1);</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;         <span class="comment">// tmpVector2 = u_{n+1}</span></div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;        tmpVector2.at(0) = Teuchos::rcp(<span class="keyword">new</span> BlockMultiVector_Type(solutionPreviousTimesteps_.at(0)));</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160; </div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;        <span class="comment">// Funktionsaufruf: Update(ScalarA, A, ScalarThis) =&gt; this = ScalarThis*this + ScalarA*A</span></div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;        tmpVector2.at(0)-&gt;update(-1.0/(dt*dt*beta), *(solutionPreviousTimesteps_.at(1)), 1.0/(dt*dt*beta));</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160; </div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;        <span class="comment">// Berechne -\frac{0.5 - beta}{beta}*u&#39;&#39;_n. ACHTUNG VORZEICHEN!!!</span></div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;        accelerationPreviousTimesteps_.at(0)-&gt;scale(-(0.5 - beta)/beta);</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160; </div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;        <span class="comment">// Addiere noch \tmpVector2 - \frac{1}{dt*beta})*u&#39;_n HINZU</span></div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;        <span class="comment">// Funktionsaufruf: Update(ScalarA, A, ScalarB, B, ScalarThis) =&gt; this = ScalarThis*this + ScalarA*A + ScalarB*B</span></div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;        accelerationPreviousTimesteps_.at(0)-&gt;update(1.0, *(tmpVector2.at(0)), -1.0/(dt*beta), *(velocityOld.at(0)), 1.0);</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;    }</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;}</div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::assembleSourceTerm( <span class="keywordtype">double</span> time ){</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;    </div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;    problem_-&gt;assembleSourceTerm(time); </div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;}</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160; </div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::BlockMultiVectorPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getSourceTerm( ) {</div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;    </div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;    <span class="keywordflow">return</span> problem_-&gt;getSourceTerm();</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;    </div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;}</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160; </div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;<span class="keywordtype">bool</span> TimeProblem&lt;SC,LO,GO,NO&gt;::hasSourceTerm( )<span class="keyword"> const</span>{</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;    </div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;    <span class="keywordflow">return</span> problem_-&gt;hasSourceTerm();</div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;    </div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;}</div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160; </div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::BlockMultiVectorPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getRhs(){</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    </div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    <span class="keywordflow">return</span> problem_-&gt;getRhs();</div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;}</div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160; </div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::BlockMultiVectorPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getRhs()<span class="keyword"> const</span>{</div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160; </div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    <span class="keywordflow">return</span> problem_-&gt;getRhs();</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;}</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160; </div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::DomainConstPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getDomain(<span class="keywordtype">int</span> i)<span class="keyword"> const </span>{</div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;    </div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;    <span class="keywordflow">return</span> problem_-&gt;getDomain(i);</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;}</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160; </div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;std::string TimeProblem&lt;SC,LO,GO,NO&gt;::getFEType(<span class="keywordtype">int</span> i){</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160; </div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;    <span class="keywordflow">return</span> problem_-&gt;getFEType(i);</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;}</div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160; </div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;<span class="keywordtype">int</span> TimeProblem&lt;SC,LO,GO,NO&gt;::getDofsPerNode(<span class="keywordtype">int</span> i){</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160; </div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;    <span class="keywordflow">return</span> problem_-&gt;getDofsPerNode(i);</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;}</div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160; </div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;std::string TimeProblem&lt;SC,LO,GO,NO&gt;::getVariableName(<span class="keywordtype">int</span> i){</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160; </div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;    <span class="keywordflow">return</span> problem_-&gt;getVariableName(i);</div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;}</div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160; </div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::BlockMatrixPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getSystem(){</div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160; </div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;    <span class="keywordflow">return</span> problem_-&gt;getSystem();</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;}</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160; </div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::BlockMatrixPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getSystemCombined(){</div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160; </div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(systemCombined_.is_null(), std::logic_error,<span class="stringliteral">&quot;system combined of TimeProblem is null.&quot;</span>);</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160; </div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;    <span class="keywordflow">return</span> systemCombined_;</div>
<div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;}</div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160; </div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::BlockMatrixPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getSystemCombined()<span class="keyword"> const</span>{</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160; </div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(systemCombined_.is_null(), std::logic_error,<span class="stringliteral">&quot;system combined of TimeProblem is null.&quot;</span>);</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160; </div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    <span class="keywordflow">return</span> systemCombined_;</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;}</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160; </div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::ProblemPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getUnderlyingProblem(){</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160; </div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    <span class="keywordflow">return</span> problem_;</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;}</div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160; </div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::addToRhs(BlockMultiVectorPtr_Type x){</div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;    </div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;    problem_-&gt;addToRhs(x);</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;}</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160; </div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::BlockMatrixPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getMassSystem(){</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160; </div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;    <span class="keywordflow">return</span> systemMass_;</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;}</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160; </div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;ParameterListPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getParameterList(){</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160; </div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;   <span class="keywordflow">return</span> parameterList_;</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;}</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160; </div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;<span class="keyword">typename</span> TimeProblem&lt;SC,LO,GO,NO&gt;::LinSolverBuilderPtr_Type TimeProblem&lt;SC,LO,GO,NO&gt;::getLinearSolverBuilder()<span class="keyword"> const</span>{</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160; </div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;    <span class="keywordflow">return</span> problem_-&gt;getLinearSolverBuilder();</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;}</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160; </div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::getValuesOfInterest( vec_dbl_Type&amp; values ){</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;    </div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;    problem_-&gt;getValuesOfInterest( values );</div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;}</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160; </div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::computeValuesOfInterestAndExport( ){</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;    </div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;    problem_-&gt;computeValuesOfInterestAndExport( );</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;}</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    </div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;    </div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC, <span class="keyword">class</span> LO, <span class="keyword">class</span> GO, <span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;Thyra::ModelEvaluatorBase::InArgs&lt;SC&gt; TimeProblem&lt;SC,LO,GO,NO&gt;::getNominalValues()<span class="keyword"> const</span></div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, <span class="stringliteral">&quot;Nonlinear problem is null.&quot;</span>);</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;    </div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;    <span class="keywordflow">return</span> nonLinProb-&gt;getNominalValues();</div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;}</div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160; </div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;Teuchos::RCP&lt;const ::Thyra::VectorSpaceBase&lt;SC&gt; &gt; TimeProblem&lt;SC,LO,GO,NO&gt;::get_x_space()<span class="keyword"> const</span>{</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, <span class="stringliteral">&quot;Nonlinear problem is null.&quot;</span>);</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;    </div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;    <span class="keywordflow">return</span> nonLinProb-&gt;get_x_space();</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;}</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160; </div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;Teuchos::RCP&lt;const ::Thyra::VectorSpaceBase&lt;SC&gt; &gt; TimeProblem&lt;SC,LO,GO,NO&gt;::get_f_space()<span class="keyword"> const</span>{</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, <span class="stringliteral">&quot;Nonlinear problem is null.&quot;</span>);</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;    <span class="keywordflow">return</span> nonLinProb-&gt;get_f_space();</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;}</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160; </div>
<div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;Thyra::ModelEvaluatorBase::InArgs&lt;SC&gt; TimeProblem&lt;SC,LO,GO,NO&gt;::createInArgs()<span class="keyword"> const</span></div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, <span class="stringliteral">&quot;Nonlinear problem is null.&quot;</span>);</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;    <span class="keywordflow">return</span> nonLinProb-&gt;createInArgs();</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;}</div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160; </div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;<span class="comment">// NOX</span></div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;Thyra::ModelEvaluatorBase::OutArgs&lt;SC&gt; TimeProblem&lt;SC,LO,GO,NO&gt;::createOutArgsImpl()<span class="keyword"> const</span></div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, <span class="stringliteral">&quot;Nonlinear problem is null.&quot;</span>);</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;    <span class="keywordflow">return</span> nonLinProb-&gt;createOutArgsImpl();</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;}</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;    </div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;Teuchos::RCP&lt;Thyra::LinearOpBase&lt;SC&gt; &gt; TimeProblem&lt;SC,LO,GO,NO&gt;::create_W_op()</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;{</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;    this-&gt;calculateNonLinResidualVec( <span class="stringliteral">&quot;standard&quot;</span>, time_ );</div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;    this-&gt;assemble(<span class="stringliteral">&quot;Newton&quot;</span>);</div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;    </div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;<span class="comment">//    TEUCHOS_TEST_FOR_EXCEPTION( true, std::logic_error, &quot;we need to fix the operators and preconditioners for TimeProblem NOX setup.&quot;);</span></div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;    </div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    std::string type = this-&gt;parameterList_-&gt;sublist(<span class="stringliteral">&quot;General&quot;</span>).get(<span class="stringliteral">&quot;Preconditioner Method&quot;</span>,<span class="stringliteral">&quot;Monolithic&quot;</span>);</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;    <span class="keywordflow">if</span> ( type  == <span class="stringliteral">&quot;Monolithic&quot;</span> )</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;        <span class="keywordflow">return</span> create_W_op_Monolithic( );</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;        <span class="keywordflow">return</span> create_W_op_Block( );</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;}</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160; </div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;Teuchos::RCP&lt;Thyra::LinearOpBase&lt;SC&gt; &gt; TimeProblem&lt;SC,LO,GO,NO&gt;::create_W_op_Monolithic()</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;{</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;    Teuchos::RCP&lt;const Thyra::LinearOpBase&lt;SC&gt; &gt; W_opConst = this-&gt;getSystemCombined()-&gt;getThyraLinOp();</div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;    Teuchos::RCP&lt;Thyra::LinearOpBase&lt;SC&gt; &gt; W_op = Teuchos::rcp_const_cast&lt;Thyra::LinearOpBase&lt;SC&gt; &gt;(W_opConst);</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;    <span class="keywordflow">return</span> W_op;</div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;}</div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160; </div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;Teuchos::RCP&lt;Thyra::LinearOpBase&lt;SC&gt; &gt; TimeProblem&lt;SC,LO,GO,NO&gt;::create_W_op_Block()</div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;{</div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;    </div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;    BlockMatrixPtr_Type system = this-&gt;getSystemCombined();</div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;    </div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;    Teuchos::RCP&lt;const ThyraBlockOp_Type&gt; W_opBlocksConst = system-&gt;getThyraLinBlockOp();</div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;    Teuchos::RCP&lt;ThyraBlockOp_Type&gt; W_opBlocks = Teuchos::rcp_const_cast&lt;ThyraBlockOp_Type &gt;(W_opBlocksConst);</div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;    Teuchos::RCP&lt;ThyraOp_Type&gt; W_op = Teuchos::rcp_dynamic_cast&lt;ThyraOp_Type &gt;(W_opBlocks);</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;    </div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;    <span class="keywordflow">return</span> W_op;</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;}</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160; </div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;Teuchos::RCP&lt;Thyra::PreconditionerBase&lt;SC&gt; &gt; TimeProblem&lt;SC,LO,GO,NO&gt;::create_W_prec()</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;{</div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160; </div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, <span class="stringliteral">&quot;Nonlinear problem is null.&quot;</span>);</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;    </div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;    <span class="keywordflow">if</span> (!nonLinProb-&gt;getPreconditionerConst()-&gt;isPreconditionerComputed()) {</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;        nonLinProb-&gt;initializeSolverBuilder();</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;        </div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;        std::string type = this-&gt;parameterList_-&gt;sublist(<span class="stringliteral">&quot;General&quot;</span>).get(<span class="stringliteral">&quot;Preconditioner Method&quot;</span>,<span class="stringliteral">&quot;Monolithic&quot;</span>);</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;        this-&gt;setBoundariesSystem();</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;        </div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;        <span class="keywordflow">if</span> ( type == <span class="stringliteral">&quot;Teko&quot;</span> || type == <span class="stringliteral">&quot;FaCSI-Teko&quot;</span> ) { <span class="comment">//we need to construct the whole preconditioner if Teko is used</span></div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;            nonLinProb-&gt;setupPreconditioner( type );</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;            precInitOnly_ = <span class="keyword">false</span>;</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;        }</div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;        <span class="keywordflow">else</span>{</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;            nonLinProb-&gt;initializePreconditioner( type );</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;        }</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;    }</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;    </div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;    Teuchos::RCP&lt;const Thyra::PreconditionerBase&lt;SC&gt; &gt; thyraPrec =  nonLinProb-&gt;getPreconditionerConst()-&gt;getThyraPrecConst();</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;    Teuchos::RCP&lt;Thyra::PreconditionerBase&lt;SC&gt; &gt; thyraPrecNonConst = Teuchos::rcp_const_cast&lt;Thyra::PreconditionerBase&lt;SC&gt; &gt;(thyraPrec);</div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;    </div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;    <span class="keywordflow">return</span> thyraPrecNonConst;</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;    </div>
<div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;}</div>
<div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;    </div>
<div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::evalModelImpl( <span class="keyword">const</span> Thyra::ModelEvaluatorBase::InArgs&lt;SC&gt; &amp;inArgs,</div>
<div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;                                              <span class="keyword">const</span> Thyra::ModelEvaluatorBase::OutArgs&lt;SC&gt; &amp;outArgs</div>
<div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;                                              )<span class="keyword"> const</span></div>
<div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;    std::string type = this-&gt;parameterList_-&gt;sublist(<span class="stringliteral">&quot;General&quot;</span>).get(<span class="stringliteral">&quot;Preconditioner Method&quot;</span>,<span class="stringliteral">&quot;Monolithic&quot;</span>);</div>
<div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;    <span class="keywordflow">if</span> ( !type.compare(<span class="stringliteral">&quot;Monolithic&quot;</span>))</div>
<div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;        evalModelImplMonolithic( inArgs, outArgs );</div>
<div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;        evalModelImplBlock( inArgs, outArgs );</div>
<div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;}</div>
<div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160; </div>
<div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::evalModelImplMonolithic( <span class="keyword">const</span> Thyra::ModelEvaluatorBase::InArgs&lt;SC&gt; &amp;inArgs,</div>
<div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;                                                        <span class="keyword">const</span> Thyra::ModelEvaluatorBase::OutArgs&lt;SC&gt; &amp;outArgs )<span class="keyword"> const</span></div>
<div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;    </div>
<div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;    </div>
<div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;    <span class="keyword">using</span> Teuchos::RCP;</div>
<div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;    <span class="keyword">using</span> Teuchos::rcp;</div>
<div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;    <span class="keyword">using</span> Teuchos::rcp_dynamic_cast;</div>
<div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;    <span class="keyword">using</span> Teuchos::rcp_const_cast;</div>
<div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;    <span class="keyword">using</span> Teuchos::ArrayView;</div>
<div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;    <span class="keyword">using</span> Teuchos::Array;</div>
<div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160; </div>
<div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION( inArgs.get_x().is_null(), std::logic_error, <span class="stringliteral">&quot;inArgs.get_x() is null.&quot;</span>);</div>
<div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;    </div>
<div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;    RCP&lt; const Thyra::VectorBase&lt; SC &gt; &gt; vecThyra = inArgs.get_x();</div>
<div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;    </div>
<div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;    RCP&lt; Thyra::VectorBase&lt; SC &gt; &gt; vecThyraNonConst = rcp_const_cast&lt;Thyra::VectorBase&lt; SC &gt; &gt;(vecThyra);</div>
<div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;    </div>
<div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;    BlockMultiVectorConstPtr_Type solConst = this-&gt;getSolutionConst();</div>
<div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;    BlockMultiVectorPtr_Type sol = rcp_const_cast&lt;BlockMultiVector_Type &gt;(solConst);</div>
<div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;    sol-&gt;fromThyraMultiVector(vecThyraNonConst);</div>
<div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;    </div>
<div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;    <span class="keyword">const</span> RCP&lt;Thyra::MultiVectorBase&lt;SC&gt; &gt; f_out = outArgs.get_f();</div>
<div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;    <span class="keyword">const</span> RCP&lt;Thyra::LinearOpBase&lt;SC&gt; &gt; W_out = outArgs.get_W_op();</div>
<div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;    <span class="keyword">const</span> RCP&lt;Thyra::PreconditionerBase&lt;SC&gt; &gt; W_prec_out = outArgs.get_W_prec();</div>
<div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;    </div>
<div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;    <span class="keyword">typedef</span> Thyra::TpetraOperatorVectorExtraction&lt;SC,LO,GO,NO&gt; tpetra_extract;</div>
<div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;    <span class="keyword">typedef</span> Xpetra::Matrix&lt;SC,LO,GO,NO&gt; XpetraMatrix_Type;</div>
<div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;    <span class="keyword">typedef</span> RCP&lt;XpetraMatrix_Type&gt; XpetraMatrixPtr_Type;</div>
<div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;    <span class="keyword">typedef</span> RCP&lt;const XpetraMatrix_Type&gt; XpetraMatrixConstPtr_Type;</div>
<div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;    </div>
<div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">bool</span> fill_f = nonnull(f_out);</div>
<div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">bool</span> fill_W = nonnull(W_out);</div>
<div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">bool</span> fill_W_prec = nonnull(W_prec_out);</div>
<div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;    </div>
<div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;    <span class="keywordflow">if</span> ( fill_f || fill_W || fill_W_prec ) {</div>
<div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;        </div>
<div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;        <span class="comment">// ****************</span></div>
<div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;        <span class="comment">// Get the underlying xpetra objects</span></div>
<div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;        <span class="comment">// ****************</span></div>
<div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;        <span class="keywordflow">if</span> (fill_f) {</div>
<div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;            </div>
<div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;            this-&gt;calculateNonLinResidualVec( <span class="stringliteral">&quot;standard&quot;</span>, time_ );</div>
<div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;                        </div>
<div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;            BlockMultiVectorConstPtr_Type resConst = this-&gt;getResidualConst();</div>
<div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;            BlockMultiVectorPtr_Type res = rcp_const_cast&lt;BlockMultiVector_Type &gt;(resConst);</div>
<div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;            </div>
<div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;            Teuchos::RCP&lt;Thyra::MultiVectorBase&lt;SC&gt; &gt; f_thyra = res-&gt;getThyraMultiVector();</div>
<div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;            f_out-&gt;assign(*f_thyra);</div>
<div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;        }</div>
<div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;        </div>
<div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;        XpetraMatrixPtr_Type W;</div>
<div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;        <span class="keywordflow">if</span> (fill_W) {</div>
<div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;            </div>
<div class="line"><a name="l01276"></a><span class="lineno"> 1276</span>&#160;            this-&gt;assemble(<span class="stringliteral">&quot;Newton&quot;</span>);</div>
<div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160; </div>
<div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;            this-&gt;setBoundariesSystem();</div>
<div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;            </div>
<div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;            Teuchos::RCP&lt;TpetraOp_Type&gt; W_tpetra = tpetra_extract::getTpetraOperator(W_out);</div>
<div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;            Teuchos::RCP&lt;TpetraMatrix_Type&gt; W_tpetraMat = Teuchos::rcp_dynamic_cast&lt;TpetraMatrix_Type&gt;(W_tpetra);</div>
<div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;            </div>
<div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;            XpetraMatrixConstPtr_Type W_systemXpetra = this-&gt;getSystemCombined()-&gt;getMergedMatrix()-&gt;getXpetraMatrix();</div>
<div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;            </div>
<div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;            XpetraMatrixPtr_Type W_systemXpetraNonConst = rcp_const_cast&lt;XpetraMatrix_Type&gt;(W_systemXpetra);</div>
<div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;            Xpetra::CrsMatrixWrap&lt;SC,LO,GO,NO&gt;&amp; crsOp = <span class="keyword">dynamic_cast&lt;</span>Xpetra::CrsMatrixWrap&lt;SC,LO,GO,NO&gt;&amp;<span class="keyword">&gt;</span>(*W_systemXpetraNonConst);</div>
<div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;            Xpetra::TpetraCrsMatrix&lt;SC,LO,GO,NO&gt;&amp; xTpetraMat = <span class="keyword">dynamic_cast&lt;</span>Xpetra::TpetraCrsMatrix&lt;SC,LO,GO,NO&gt;&amp;<span class="keyword">&gt;</span>(*crsOp.getCrsMatrix());</div>
<div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;            Teuchos::RCP&lt;TpetraMatrix_Type&gt; tpetraMatXpetra = xTpetraMat.getTpetra_CrsMatrixNonConst();</div>
<div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;            </div>
<div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;            W_tpetraMat-&gt;resumeFill();</div>
<div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;            </div>
<div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;            <span class="keywordflow">for</span> (<span class="keyword">auto</span> i=0; i&lt;tpetraMatXpetra-&gt;getMap()-&gt;getNodeNumElements(); i++) {</div>
<div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;                ArrayView&lt; const LO &gt; indices;</div>
<div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;                ArrayView&lt; const SC &gt; values;</div>
<div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;                tpetraMatXpetra-&gt;getLocalRowView( i, indices, values);</div>
<div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;                W_tpetraMat-&gt;replaceLocalValues( i, indices.size(), values.getRawPtr(), indices.getRawPtr() );</div>
<div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;            }</div>
<div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;            W_tpetraMat-&gt;fillComplete();</div>
<div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;            </div>
<div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;        }</div>
<div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;        </div>
<div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;        <span class="keywordflow">if</span> (fill_W_prec) {</div>
<div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;            this-&gt;problem_-&gt;setupPreconditioner( <span class="stringliteral">&quot;Monolithic&quot;</span> );</div>
<div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;            </div>
<div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;            <span class="comment">// ch 26.04.19: After each setup of the preconditioner we check if we use a two-level precondtioner with multiplicative combination between the levels.</span></div>
<div class="line"><a name="l01306"></a><span class="lineno"> 1306</span>&#160;            <span class="comment">// If this is the case, we need to pre apply the coarse level to the residual(f_out).</span></div>
<div class="line"><a name="l01307"></a><span class="lineno"> 1307</span>&#160;            </div>
<div class="line"><a name="l01308"></a><span class="lineno"> 1308</span>&#160;            std::string levelCombination = this-&gt;parameterList_-&gt;sublist(<span class="stringliteral">&quot;ThyraPreconditioner&quot;</span>).sublist(<span class="stringliteral">&quot;Preconditioner Types&quot;</span>).sublist(<span class="stringliteral">&quot;FROSch&quot;</span>).get(<span class="stringliteral">&quot;Level Combination&quot;</span>,<span class="stringliteral">&quot;Additive&quot;</span>);</div>
<div class="line"><a name="l01309"></a><span class="lineno"> 1309</span>&#160;            <span class="keywordflow">if</span> (!levelCombination.compare(<span class="stringliteral">&quot;Multiplicative&quot;</span>)) {</div>
<div class="line"><a name="l01310"></a><span class="lineno"> 1310</span>&#160;                TEUCHOS_TEST_FOR_EXCEPTION(<span class="keyword">true</span>, std::logic_error, <span class="stringliteral">&quot;Multiplicative Level Combination is not supported for NOX.&quot;</span>);</div>
<div class="line"><a name="l01311"></a><span class="lineno"> 1311</span>&#160;            }</div>
<div class="line"><a name="l01312"></a><span class="lineno"> 1312</span>&#160;            </div>
<div class="line"><a name="l01313"></a><span class="lineno"> 1313</span>&#160;        }</div>
<div class="line"><a name="l01314"></a><span class="lineno"> 1314</span>&#160;    }</div>
<div class="line"><a name="l01315"></a><span class="lineno"> 1315</span>&#160;}</div>
<div class="line"><a name="l01316"></a><span class="lineno"> 1316</span>&#160; </div>
<div class="line"><a name="l01317"></a><span class="lineno"> 1317</span>&#160; </div>
<div class="line"><a name="l01318"></a><span class="lineno"> 1318</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01319"></a><span class="lineno"> 1319</span>&#160;<span class="keywordtype">void</span> TimeProblem&lt;SC,LO,GO,NO&gt;::evalModelImplBlock( <span class="keyword">const</span> Thyra::ModelEvaluatorBase::InArgs&lt;SC&gt; &amp;inArgs,</div>
<div class="line"><a name="l01320"></a><span class="lineno"> 1320</span>&#160;                                                   <span class="keyword">const</span> Thyra::ModelEvaluatorBase::OutArgs&lt;SC&gt; &amp;outArgs )<span class="keyword"> const</span></div>
<div class="line"><a name="l01321"></a><span class="lineno"> 1321</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;    </div>
<div class="line"><a name="l01323"></a><span class="lineno"> 1323</span>&#160;    </div>
<div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;    <span class="keyword">using</span> Teuchos::RCP;</div>
<div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;    <span class="keyword">using</span> Teuchos::rcp;</div>
<div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;    <span class="keyword">using</span> Teuchos::rcp_dynamic_cast;</div>
<div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;    <span class="keyword">using</span> Teuchos::rcp_const_cast;</div>
<div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;    <span class="keyword">using</span> Teuchos::ArrayView;</div>
<div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;    <span class="keyword">using</span> Teuchos::Array;</div>
<div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;    </div>
<div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION( inArgs.get_x().is_null(), std::logic_error, <span class="stringliteral">&quot;inArgs.get_x() is null.&quot;</span>);</div>
<div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;    </div>
<div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;    RCP&lt; const Thyra::VectorBase&lt; SC &gt; &gt; vecThyra = inArgs.get_x();</div>
<div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;    </div>
<div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;    RCP&lt; Thyra::VectorBase&lt; SC &gt; &gt; vecThyraNonConst = rcp_const_cast&lt;Thyra::VectorBase&lt; SC &gt; &gt;(vecThyra);</div>
<div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;    </div>
<div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;    RCP&lt; Thyra::ProductVectorBase&lt; SC &gt; &gt; vecThyraBlock = rcp_dynamic_cast&lt;Thyra::ProductVectorBase&lt; SC &gt; &gt; (vecThyraNonConst);</div>
<div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;    BlockMultiVectorConstPtr_Type solConst = this-&gt;getSolutionConst();</div>
<div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;    BlockMultiVectorPtr_Type sol = rcp_const_cast&lt;BlockMultiVector_Type &gt;(solConst);</div>
<div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;sol-&gt;size(); i++)</div>
<div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;        sol-&gt;getBlockNonConst(i)-&gt;fromThyraMultiVector( vecThyraBlock-&gt;getNonconstVectorBlock(i) );</div>
<div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;    </div>
<div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;    <span class="keyword">const</span> RCP&lt;Thyra::MultiVectorBase&lt;SC&gt; &gt; f_out = outArgs.get_f();</div>
<div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;    <span class="keyword">const</span> RCP&lt;Thyra::LinearOpBase&lt;SC&gt; &gt; W_out = outArgs.get_W_op();</div>
<div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;    <span class="keyword">const</span> RCP&lt;Thyra::PreconditionerBase&lt;SC&gt; &gt; W_prec_out = outArgs.get_W_prec();</div>
<div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;    </div>
<div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;    <span class="keyword">typedef</span> Thyra::TpetraOperatorVectorExtraction&lt;SC,LO,GO,NO&gt; tpetra_extract;</div>
<div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;    <span class="keyword">typedef</span> Xpetra::Matrix&lt;SC,LO,GO,NO&gt; XpetraMatrix_Type;</div>
<div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;    <span class="keyword">typedef</span> RCP&lt;XpetraMatrix_Type&gt; XpetraMatrixPtr_Type;</div>
<div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;    <span class="keyword">typedef</span> RCP&lt;const XpetraMatrix_Type&gt; XpetraMatrixConstPtr_Type;</div>
<div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;    </div>
<div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">bool</span> fill_f = nonnull(f_out);</div>
<div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">bool</span> fill_W = nonnull(W_out);</div>
<div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">bool</span> fill_W_prec = nonnull(W_prec_out);</div>
<div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;    </div>
<div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;    <span class="keywordflow">if</span> ( fill_f || fill_W || fill_W_prec ) {</div>
<div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;        </div>
<div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;        <span class="comment">// ****************</span></div>
<div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;        <span class="comment">// Get the underlying xpetra objects</span></div>
<div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;        <span class="comment">// ****************</span></div>
<div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;        <span class="keywordflow">if</span> (fill_f) {</div>
<div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;            </div>
<div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;            this-&gt;calculateNonLinResidualVec(<span class="stringliteral">&quot;standard&quot;</span> , time_);</div>
<div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;            </div>
<div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;            RCP&lt; Thyra::ProductMultiVectorBase&lt;SC&gt; &gt; f_outBlocks</div>
<div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;                = rcp_dynamic_cast&lt; Thyra::ProductMultiVectorBase&lt;SC&gt; &gt; ( f_out );</div>
<div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160; </div>
<div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;            BlockMultiVectorConstPtr_Type resConst = this-&gt;getResidualConst();</div>
<div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;            BlockMultiVectorPtr_Type res = rcp_const_cast&lt;BlockMultiVector_Type &gt;(resConst);</div>
<div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160; </div>
<div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;res-&gt;size(); i++) {</div>
<div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;                RCP&lt; Thyra::MultiVectorBase&lt; SC &gt; &gt; res_i =</div>
<div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;                    res-&gt;getBlockNonConst(i)-&gt;getThyraMultiVector();</div>
<div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160; </div>
<div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;                RCP&lt; Thyra::MultiVectorBase&lt; SC &gt; &gt; f_i = f_outBlocks-&gt;getNonconstMultiVectorBlock(i);</div>
<div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;                f_i-&gt;assign(*res_i);</div>
<div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;            }</div>
<div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;        }</div>
<div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;        </div>
<div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;        XpetraMatrixPtr_Type W;</div>
<div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;        <span class="keywordflow">if</span> (fill_W) {</div>
<div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;            </div>
<div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;            <span class="keyword">typedef</span> Tpetra::CrsMatrix&lt;SC,LO,GO,NO&gt; TpetraCrsMatrix;</div>
<div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;            </div>
<div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;            this-&gt;assemble(<span class="stringliteral">&quot;Newton&quot;</span>);</div>
<div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;            </div>
<div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;            this-&gt;setBoundariesSystem();</div>
<div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;            </div>
<div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;            RCP&lt;ThyraBlockOp_Type&gt; W_blocks = rcp_dynamic_cast&lt;ThyraBlockOp_Type&gt;(W_out);</div>
<div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160; </div>
<div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;            BlockMatrixPtr_Type system = this-&gt;getSystemCombined();</div>
<div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;            </div>
<div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i&lt;system-&gt;size(); i++) {</div>
<div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j=0; j&lt;system-&gt;size(); j++) {</div>
<div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;                    <span class="keywordflow">if</span> ( system-&gt;blockExists(i,j) ) {</div>
<div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;                        RCP&lt;const ThyraOp_Type&gt; W = W_blocks-&gt;getBlock(i,j);</div>
<div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;                        RCP&lt;ThyraOp_Type&gt; W_NonConst = rcp_const_cast&lt;ThyraOp_Type&gt;( W );</div>
<div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;                        RCP&lt;TpetraOp_Type&gt; W_tpetra = tpetra_extract::getTpetraOperator( W_NonConst );</div>
<div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;                        RCP&lt;TpetraMatrix_Type&gt; W_tpetraMat = Teuchos::rcp_dynamic_cast&lt;TpetraMatrix_Type&gt;(W_tpetra);</div>
<div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;                        </div>
<div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;                        XpetraMatrixConstPtr_Type W_matrixXpetra = system-&gt;getBlock(i,j)-&gt;getXpetraMatrix();</div>
<div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;                        XpetraMatrixPtr_Type W_matrixXpetraNonConst = rcp_const_cast&lt;XpetraMatrix_Type&gt;(W_matrixXpetra);</div>
<div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;                        Xpetra::CrsMatrixWrap&lt;SC,LO,GO,NO&gt;&amp; crsOp = <span class="keyword">dynamic_cast&lt;</span>Xpetra::CrsMatrixWrap&lt;SC,LO,GO,NO&gt;&amp;<span class="keyword">&gt;</span>(*W_matrixXpetraNonConst);</div>
<div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;                        Xpetra::TpetraCrsMatrix&lt;SC,LO,GO,NO&gt;&amp; xTpetraMat = <span class="keyword">dynamic_cast&lt;</span>Xpetra::TpetraCrsMatrix&lt;SC,LO,GO,NO&gt;&amp;<span class="keyword">&gt;</span>(*crsOp.getCrsMatrix());</div>
<div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;                        RCP&lt;TpetraMatrix_Type&gt; tpetraMatXpetra = xTpetraMat.getTpetra_CrsMatrixNonConst();</div>
<div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;                        </div>
<div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;                        W_tpetraMat-&gt;resumeFill();</div>
<div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;                        </div>
<div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;                        <span class="keywordflow">for</span> (<span class="keyword">auto</span> i=0; i&lt;tpetraMatXpetra-&gt;getMap()-&gt;getNodeNumElements(); i++) {</div>
<div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;                            ArrayView&lt; const LO &gt; indices;</div>
<div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;                            ArrayView&lt; const SC &gt; values;</div>
<div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;                            tpetraMatXpetra-&gt;getLocalRowView( i, indices, values);</div>
<div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;                            W_tpetraMat-&gt;replaceLocalValues( i, indices.size(), values.getRawPtr(), indices.getRawPtr() );</div>
<div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;                        }</div>
<div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;                        W_tpetraMat-&gt;fillComplete( W_tpetraMat-&gt;getDomainMap(), W_tpetraMat-&gt;getRangeMap() );</div>
<div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;                    }</div>
<div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;                }</div>
<div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;            }</div>
<div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;        }</div>
<div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;        </div>
<div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;        <span class="keywordflow">if</span> (fill_W_prec) {</div>
<div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;            std::string type = this-&gt;parameterList_-&gt;sublist(<span class="stringliteral">&quot;General&quot;</span>).get(<span class="stringliteral">&quot;Preconditioner Method&quot;</span>,<span class="stringliteral">&quot;Monolithic&quot;</span>);</div>
<div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;            <span class="keywordflow">if</span> (precInitOnly_)</div>
<div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;                this-&gt;problem_-&gt;setupPreconditioner( type );</div>
<div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;            <span class="keywordflow">else</span></div>
<div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;                precInitOnly_ = <span class="keyword">true</span>; <span class="comment">// If a Teko preconditioner was constructed for the first time this variable is false. Because the preconditioner was not only initialized but already constructed. We can now set this variable to true to always setup all following preconditioners in the above if case</span></div>
<div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;            </div>
<div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;        }</div>
<div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;    }</div>
<div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;}</div>
<div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;<span class="keyword">template</span>&lt;<span class="keyword">class</span> SC,<span class="keyword">class</span> LO,<span class="keyword">class</span> GO,<span class="keyword">class</span> NO&gt;</div>
<div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;std::string TimeProblem&lt;SC,LO,GO,NO&gt;::description()<span class="keyword"> const</span>{ <span class="comment">//reimplement description function and use description of underlying nonLinearProblem</span></div>
<div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;    NonLinProbPtr_Type nonLinProb = Teuchos::rcp_dynamic_cast&lt;NonLinProb_Type&gt;(problem_);</div>
<div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;    TEUCHOS_TEST_FOR_EXCEPTION(nonLinProb.is_null(), std::runtime_error, <span class="stringliteral">&quot;Nonlinear problem is null.&quot;</span>);</div>
<div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;    <span class="keywordflow">return</span> nonLinProb-&gt;description();</div>
<div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;}</div>
<div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;}</div>
<div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;<span class="preprocessor">#endif</span></div>
</div><!-- fragment --></div><!-- contents -->
<div class="ttc" id="anamespaceFEDD_html"><div class="ttname"><a href="../../d0/dac/namespaceFEDD.html">FEDD</a></div><div class="ttdoc">Domain.</div><div class="ttdef"><b>Definition:</b> AssembleFE_decl.hpp:9</div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
